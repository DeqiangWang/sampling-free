from maskrcnn_benchmark.config import cfg
from predictor import COCODemo
import cv2
import os

baseline_thresh = [0.6009693145751953, 0.6766153573989868, 0.6748730540275574, 0.5851236581802368, 0.8067564368247986, 0.6829034090042114, 0.6540001034736633, 0.42086920142173767, 0.6310264468193054, 0.576596736907959, 0.7182245850563049, 0.8081580400466919, 0.8449401259422302, 0.5791822671890259, 0.476797878742218, 0.7098460793495178, 0.5903158187866211, 0.7720410823822021, 0.7110618352890015, 0.47929781675338745, 0.737158477306366, 0.8458963632583618, 0.7947010397911072, 0.814479649066925, 0.44098997116088867, 0.5322158336639404, 0.41824302077293396, 0.6017897129058838, 0.4245312213897705, 0.6012450456619263, 0.5555493235588074, 0.7180959582328796, 0.8603506088256836, 0.5177062153816223, 0.5682739019393921, 0.6953546404838562, 0.7728491425514221, 0.48887258768081665, 0.7383052110671997, 0.5972691178321838, 0.5702030658721924, 0.6619213223457336, 0.39320287108421326, 0.5086840987205505, 0.47394871711730957, 0.5428017973899841, 0.3993377685546875, 0.43173208832740784, 0.5753902196884155, 0.5041504502296448, 0.5363325476646423, 0.5817720890045166, 0.699409008026123, 0.6435895562171936, 0.32349860668182373, 0.5820318460464478, 0.5477358102798462, 0.5836631059646606, 0.5132163763046265, 0.5897954106330872, 0.6419715881347656, 0.6746179461479187, 0.6194209456443787, 0.6327039003372192, 0.6144891977310181, 0.5837699770927429, 0.6752408742904663, 0.6771562695503235, 0.7430931925773621, 0.5378075242042542, 0.5998000502586365, 0.6449807286262512, 0.749815046787262, 0.4008117616176605, 0.7942065596580505, 0.642356812953949, 0.6166144013404846, 0.6440011262893677, 0.07464557141065598, 0.41135841608047485]
# its f1-score: 0.5965259672177909
# [0.7782656176870446, 0.4936831875607387, 0.6619157968131575, 0.6609161213563355, 0.8149444215726637, 0.7715654952076678, 0.7867283458286808, 0.538659793814433, 0.5158620689655172, 0.577622189309277, 0.8652308578837429, 0.7500000000000001, 0.6521739130434783, 0.37230357060372304, 0.578854105138807, 0.8825194621372966, 0.7977552341895101, 0.7227926078028748, 0.6845208717562408, 0.6924850376097436, 0.8215794257605732, 0.8438037865748709, 0.8715534633490248, 0.8621089223638472, 0.38209913706602444, 0.6512956539481739, 0.3498920086393088, 0.5719913334646444, 0.5989672977624785, 0.7925750303591048, 0.23344017094017094, 0.48198464264619023, 0.6483790523690773, 0.5861424250756119, 0.5527084009082064, 0.6079523174652969, 0.6936800725733293, 0.584571343961305, 0.7685802239437095, 0.593743000074666, 0.5634264315805898, 0.5824114969542256, 0.42880673499267935, 0.30347448425624324, 0.31816160118606374, 0.5587512150494596, 0.4425433377287492, 0.35282006826678225, 0.488214664383003, 0.482670906200318, 0.48940823187648924, 0.39535901926444833, 0.46119873817034707, 0.6928876848255378, 0.6110228211811075, 0.5736398816298658, 0.43516879934658315, 0.5936820049963736, 0.5165859112933284, 0.6236220472440945, 0.36813611755607123, 0.7714443829551743, 0.7370658165637245, 0.7527018436109345, 0.8076620309630018, 0.5316746073760368, 0.7095115681233933, 0.5253190613421161, 0.7249712313003452, 0.5677950252478026, 0.5301204819277109, 0.5809768637532133, 0.704791344667697, 0.3086083915207281, 0.7523148148148149, 0.5731462925851702, 0.5105566218809982, 0.6647230320699709, 0.24884792626728108, 0.3420074349442379]

# sampling-free: 0.624778578086193
free_thresh = [0.40836647152900696, 0.5883768796920776, 0.4973059892654419, 0.49787023663520813, 0.6815237402915955, 0.6421763300895691, 0.5636156797409058, 0.386392742395401, 0.3138643503189087, 0.4242801368236542, 0.8023367524147034, 0.5749799013137817, 0.7088608145713806, 0.39975133538246155, 0.22852887213230133, 0.5815382599830627, 0.6750882267951965, 0.7208858132362366, 0.588912844657898, 0.6456626653671265, 0.36632248759269714, 0.7442012429237366, 0.7743787169456482, 0.8392951488494873, 0.3089240789413452, 0.3142017126083374, 0.1881052851676941, 0.3773036301136017, 0.41472935676574707, 0.3856079876422882, 0.4522726237773895, 0.5759906768798828, 0.4667891263961792, 0.39420583844184875, 0.6828474998474121, 0.39770960807800293, 0.6465439796447754, 0.5216158032417297, 0.4614114463329315, 0.4713174104690552, 0.3299848437309265, 0.546069860458374, 0.35830578207969666, 0.33639955520629883, 0.4392954409122467, 0.5412867069244385, 0.2150624394416809, 0.17846502363681793, 0.46047836542129517, 0.2735828757286072, 0.43467092514038086, 0.4543546140193939, 0.3828335702419281, 0.563357949256897, 0.4177246689796448, 0.4307236969470978, 0.35901737213134766, 0.3806508779525757, 0.3854299485683441, 0.3950069844722748, 0.4102804362773895, 0.5778281688690186, 0.5814635753631592, 0.7484567761421204, 0.5120485424995422, 0.3864794969558716, 0.3273776173591614, 0.48768582940101624, 0.6405259370803833, 0.4430214464664459, 0.382080078125, 0.6818448901176453, 0.5987183451652527, 0.19766078889369965, 0.4662286937236786, 0.5517673492431641, 0.49106281995773315, 0.568229615688324, 0.04861709848046303, 0.5030775666236877]
# its f1-score
# [0.7998848849877691, 0.6144200626959248, 0.6812935157995826, 0.7297774958082204, 0.8372434735759416, 0.7830241708825183, 0.8002050392334686, 0.5513792679427798, 0.56490727532097, 0.5931969026548672, 0.8475836431226765, 0.7445255474452556, 0.631578947368421, 0.43873775843307955, 0.6204986149584488, 0.8728018924387949, 0.7848909873628662, 0.7793331330729949, 0.7097215437225208, 0.7309961818812913, 0.8340931438276571, 0.843403205918619, 0.8760925449871466, 0.868144690781797, 0.385511544164372, 0.6422145328719724, 0.35391988425716614, 0.6206681236340931, 0.6074404761904761, 0.812473925740509, 0.5371344414054282, 0.5574370709382152, 0.6829079387431789, 0.6634942216179469, 0.5766283524904214, 0.6354350123282846, 0.7614131885734626, 0.6430418250950571, 0.7431593638667499, 0.6045846443018837, 0.6054910933159012, 0.5795601552393274, 0.5336185819070904, 0.3754512635379062, 0.3617057138041463, 0.6031735116642886, 0.45559260381933925, 0.36029853307025816, 0.522235576923077, 0.46255629756173317, 0.46613669671803526, 0.4213346730302269, 0.5685872462579455, 0.7175891391914069, 0.5795053003533569, 0.5729553709347472, 0.4933287482806052, 0.6263407333499625, 0.5213414634146342, 0.656970704342406, 0.4849762783342119, 0.7652001977261492, 0.726948245092207, 0.7762744804903572, 0.7996882307092751, 0.5217391304347826, 0.6956588316361688, 0.5887640449438202, 0.777115987460815, 0.5603112840466925, 0.6626506024096386, 0.5950413223140497, 0.7306465642215134, 0.40729452229733176, 0.7449139280125197, 0.5732217573221757, 0.4672566371681416, 0.6854037848978827, 0.09473684210526315, 0.47547169811320755]

config_file = "backup/mask_rcnn/39.0ap+34.9ap_mask_rcnn_R_50_FPN_1x_freex2.0/config.yml"
weight_file = "backup/mask_rcnn/39.0ap+34.9ap_mask_rcnn_R_50_FPN_1x_freex2.0/model_final.pth"

# update the config options with the config file
cfg.merge_from_file(config_file)
# manual override some options
cfg.merge_from_list(["MODEL.DEVICE", "cuda"])
cfg.merge_from_list(["TEST_ON", True])
cfg.merge_from_list(["TEST.IMS_PER_BATCH", 1])
cfg.merge_from_list(["MODEL.WEIGHT", weight_file])
cfg.merge_from_list(["MODEL.SAMPLING_FREE_ON", True])

coco_demo = COCODemo(
    cfg,
    min_image_size=800,
    confidence_threshold=free_thresh,
)

image_fold = "datasets/coco/val2017/"
output_fold = "demo/mask_rcnn_R_50_FPN_1x_freex2/"
if not os.path.exists(output_fold):
    os.mkdir(output_fold)
image_files = os.listdir(image_fold)
image_files = [image_fold + i for i in image_files]
# load image and then run prediction
for i, image_file in enumerate(image_files):
    predictions = coco_demo.run_on_opencv_image(cv2.imread(image_file))
    cv2.imwrite(output_fold+str(i)+".jpg", predictions)
    if i % 100 == 0:
        print(str(i) + " images finished...")
